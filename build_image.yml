.build_docker:
    stage: build
    only: [master, tags]
    image: docker:stable
    services: ["docker:dind"]
    variables:
        # Until this issue is resolved: https://gitlab.com/gitlab-org/gitlab-runner/issues/1736
        GIT_STRATEGY: none
    script:
        - DOCKER_DRIVER=overlay2
        - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
        - apk add git
        - cd $CI_BUILDS_DIR
        - rm -rf $CI_PROJECT_DIR
        - git clone $CI_REPOSITORY_URL $CI_PROJECT_DIR
        - cd $CI_PROJECT_DIR
        - git checkout $CI_COMMIT_SHA
        - git submodule update --init
        - >
            docker build \
                --tag $CI_REGISTRY_IMAGE:$(eval $VERSION_SCRIPT)-$ARCH \
                --tag $CI_REGISTRY_IMAGE:latest-$ARCH \
                --file ${DOCKERFILE:-./Dockerfile} \
                ./

        - docker push $CI_REGISTRY_IMAGE

build:amd64:
    extends: .build_docker
    tags: [docker, gce]
    variables:
        ARCH: amd64

build:armv7:
    extends: .build_docker
    tags: [docker, odroid]
    variables:
        ARCH: armv7

create_manifest:
    only: [master, tags]
    image: docker:stable
    services: ["docker:dind"]
    script:
        - apk add jq
        - mkdir -p /root/.docker
        - echo "{}" | jq '.experimental = "enabled"' > ~/.docker/config.json
        - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
        - >
            docker manifest create \
                $CI_REGISTRY_IMAGE:$(eval $VERSION_SCRIPT) \
                $CI_REGISTRY_IMAGE:$(eval $VERSION_SCRIPT)-amd64 \
                $CI_REGISTRY_IMAGE:$(eval $VERSION_SCRIPT)-armv7
        - >
            docker manifest create \
                $CI_REGISTRY_IMAGE:latest \
                $CI_REGISTRY_IMAGE:latest-amd64 \
                $CI_REGISTRY_IMAGE:latest-armv7
        - "docker manifest push $CI_REGISTRY_IMAGE:$(eval $VERSION_SCRIPT)"
        - "docker manifest push $CI_REGISTRY_IMAGE:latest"
